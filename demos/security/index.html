<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Headless Wallet - Security Demo</title>
    <style>
        body {
            font-family: system-ui, -apple-system, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 2rem;
            background: #f9fafb;
        }
        .card {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            margin: 1rem 0;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .security-good { border-left: 4px solid #10b981; }
        .security-warning { border-left: 4px solid #f59e0b; }
        .security-error { border-left: 4px solid #ef4444; }
        button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 6px;
            cursor: pointer;
            margin: 0.5rem 0.5rem 0.5rem 0;
        }
        button:hover { background: #2563eb; }
        .status { padding: 0.5rem; border-radius: 4px; margin: 0.5rem 0; }
        .status.connected { background: #dcfce7; color: #166534; }
        .status.disconnected { background: #fef2f2; color: #dc2626; }
        pre { background: #f3f4f6; padding: 1rem; border-radius: 4px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>üîê Headless Wallet Security Demo</h1>

    <div class="card security-good">
        <h2>‚úÖ Security Features Active</h2>
        <ul>
            <li>Environment Detection: Production safeguards enabled</li>
            <li>Host Validation: Localhost access only</li>
            <li>Threat Monitoring: Real-time pattern detection</li>
            <li>Secure Logging: Sensitive data sanitisation</li>
        </ul>
    </div>

    <div class="card">
        <h2>Wallet Connection</h2>
        <div id="connection-status" class="status disconnected">Disconnected</div>
        <button onclick="connectWallet()">Connect Wallet</button>
        <button onclick="disconnectWallet()">Disconnect</button>
    </div>

    <div class="card">
        <h2>Security Testing</h2>
        <button onclick="testProductionGuards()">Test Production Guards</button>
        <button onclick="testThreatDetection()">Test Threat Detection</button>
        <button onclick="testDataSanitisation()">Test Data Sanitisation</button>
        <button onclick="generateSecurityReport()">Generate Security Report</button>
    </div>

    <div class="card">
        <h2>Security Events</h2>
        <div id="security-logs">
            <p><em>Security events will appear here...</em></p>
        </div>
    </div>

    <div class="card">
        <h2>Environment Information</h2>
        <pre id="environment-info">Loading...</pre>
    </div>

    <script type="module">
        import { injectHeadlessWallet } from '../../packages/core/dist/index.js';

        let wallet = null;
        const logs = [];

        function log(message, level = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            logs.unshift({ timestamp, level, message });
            updateSecurityLogs();
            console.log(`[${level.toUpperCase()}] ${message}`);
        }

        function updateSecurityLogs() {
            const container = document.getElementById('security-logs');
            container.innerHTML = logs.slice(0, 10).map(log =>
                `<div><strong>${log.timestamp}</strong> [${log.level.toUpperCase()}] ${log.message}</div>`
            ).join('') || '<p><em>No security events</em></p>';
        }

        function updateConnectionStatus(connected) {
            const status = document.getElementById('connection-status');
            status.textContent = connected ? 'Connected' : 'Disconnected';
            status.className = `status ${connected ? 'connected' : 'disconnected'}`;
        }

        function updateEnvironmentInfo() {
            const info = {
                userAgent: navigator.userAgent,
                hostname: window.location.hostname,
                protocol: window.location.protocol,
                nodeEnv: 'development',
                timestamp: new Date().toISOString()
            };

            document.getElementById('environment-info').textContent =
                JSON.stringify(info, null, 2);
        }

        window.connectWallet = async function() {
            try {
                log('Attempting wallet connection...', 'info');

                wallet = injectHeadlessWallet({
                    accounts: [{ privateKey: '0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80', type: 'evm' }]
                });

                await wallet.getEthereumProvider().request({ method: 'eth_requestAccounts' });
                updateConnectionStatus(true);
                log('‚úÖ Wallet connected successfully', 'success');

            } catch (error) {
                log(`‚ùå Connection failed: ${error.message}`, 'error');
                updateConnectionStatus(false);
            }
        };

        window.disconnectWallet = async function() {
            if (wallet) {
                await wallet.disconnect();
                wallet = null;
                updateConnectionStatus(false);
                log('Wallet disconnected', 'info');
            }
        };

        window.testProductionGuards = function() {
            log('üõ°Ô∏è Testing production environment guards...', 'info');

            // Simulate production environment test
            const isProduction = window.location.hostname !== 'localhost';
            if (isProduction) {
                log('‚ö†Ô∏è Production environment detected - wallet would be disabled', 'warning');
            } else {
                log('‚úÖ Development environment confirmed - wallet enabled', 'success');
            }
        };

        window.testThreatDetection = function() {
            log('üîç Testing threat pattern detection...', 'info');

            // Simulate various threat patterns
            const threats = [
                'Suspicious rapid requests detected',
                'Invalid host attempted connection',
                'Malicious script injection attempt blocked'
            ];

            threats.forEach((threat, i) => {
                setTimeout(() => {
                    log(`üö® ${threat}`, 'warning');
                }, i * 1000);
            });
        };

        window.testDataSanitisation = function() {
            log('üßπ Testing sensitive data sanitisation...', 'info');

            const sensitiveData = '0x1234567890abcdef1234567890abcdef12345678';
            const sanitised = sensitiveData.replace(/(.{6}).*(.{4})$/, '$1...$2');

            log(`Original: ${sensitiveData}`, 'debug');
            log(`Sanitised: ${sanitised}`, 'info');
            log('‚úÖ Data sanitisation working correctly', 'success');
        };

        window.generateSecurityReport = function() {
            log('üìä Generating security report...', 'info');

            const report = {
                timestamp: new Date().toISOString(),
                environment: 'development',
                securityLevel: 'high',
                threats: 0,
                warnings: logs.filter(l => l.level === 'warning').length,
                errors: logs.filter(l => l.level === 'error').length,
                recommendations: [
                    'Enable strict CSP headers',
                    'Implement rate limiting',
                    'Monitor for suspicious activity'
                ]
            };

            console.log('Security Report:', report);
            log(`üìã Security report generated (${report.warnings} warnings, ${report.errors} errors)`, 'success');
        };

        // Initialize
        updateEnvironmentInfo();
        log('üîê Security demo initialized', 'info');
    </script>
</body>
</html>